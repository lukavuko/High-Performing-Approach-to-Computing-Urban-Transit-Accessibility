---
title: "Merge Travel Time Matrix to Amenity"
author: "Rain Shen"
output:
  html_document:
    df_print: paged
---

### Combining travel time matrix with 1-hour time window and amenity locations

### 0) Useful Libraries

```{r message=FALSE, warning=FALSE, include=TRUE}

library(tidyverse)
library(glue)
library(stringr)
library(sf)
library(data.table)

path_data <- "../../data/2_clean/"
path_data2 <- "../../data/3_computed/ttm_Kepler_comparison/"
```


### 1) Data Preparation for origins and destinations

- Origins correspond to the centroid coordinates of Canadian Census 2016
dissemination blocks across Canada. This was filtered by metropolitan area (MA)
to keep only Greater Vancouver city blocks.
- Destinations correspond to the amenity coordinates of the OCDAF database.

### Import all dissemination block data
```{r message=FALSE, warning=FALSE, eval=FALSE}
# import dissemination blocks

origins <- fread(file.path(paste0(path_data, "vancouver_db.csv")))

# remove population and change column types
origins$pop <- NULL  
origins$id <- as.factor(origins$id)  

n_origins <- nrow(origins)
paste('Origin Rows: ', n_origins)

# Peek
head(origins)
```


### Import all amenity data
```{r message=FALSE, warning=FALSE, eval=FALSE}

# import cultural/Art facilities
destinations <- fread(file.path(paste0(path_data, "vancouver_facilities.csv")))

# clean amenities / filter types to keep 4 most frequent amenities
target_amenities <- c('gallery', 'museum', 'library or archives', 'theatre/performance and concert hall')
destinations <- destinations %>% filter(type %in% target_amenities)

# change col types
destinations$type <- as.factor(destinations$type)
destinations$id <- as.factor(destinations$id)  

n_amenities <- nrow(destinations)
paste('Destinations: ', n_amenities)
head(destinations)
```


### Import the travel time matrix with time window

- travel time matrix with time window data were generated by "many_to_many_point_computation.Rmd"
- merge the the time window travel time matrix to amenity data with locations
- merged data will be used for Kepler.gl maps of transit time to the nearest amenity through the time of the day

```{r kable.opts=list(caption='Summary Table'), message=FALSE, warning=FALSE, eval=FALSE}

# import travel time matrix
# read data from gz zip file
ttm <- read.table(unz("../../data/3_computed/ttm_by_day/all_days_ttm.zip",
                    "all_days_ttm.csv"), header=T, quote="\"", sep=",")

# convert Ids to  factor
ttm$fromId <- as.factor(ttm$fromId)
ttm$toId <- as.factor(ttm$toId)

# add amenity types
# use left join since we only care to keep existing amenities in the ttm
ttm <-  left_join(ttm, destinations, by = c('toId' = 'id'))

# remove name and city
ttm$name <- NULL
ttm$city <- NULL
ttm$city_id <- NULL

head(ttm)
```

### 3) Prepare data for Isochrones map to the nearest amenity

- compute the transit time for each dissemination block to the nearest amenity for each of the 4 types

```{r message=FALSE, warning=FALSE, eval=FALSE}

# only consider the nearest amenity
near1 <- ttm %>%
  group_by(fromId, type, t1) %>%
  summarise(avg_time = min(travel_time),
            Dest = toId[which.min(travel_time)],
            Latitude = lat[which.min(travel_time)],
            Longitude = lon[which.min(travel_time)])


# Remove null values
na.omit(near1)->near1

```

```{r message=FALSE, warning=FALSE, eval=FALSE}
# Columns for all the origins
near1_from <- near1[ , c(1,2,3,4)]

# Columns for all the destinations
near1_to <- near1[ , c(2,5,6,7)]
```

```{r message=FALSE, warning=FALSE, eval=FALSE}
## Export
write.csv(near1_from, 'ttm5_from.csv', row.names = FALSE)
write.csv(near1_to, 'ttm5_to.csv', row.names = FALSE)

# Overall
write.csv(near1, 'ttm5_719.csv', row.names = FALSE)
```

